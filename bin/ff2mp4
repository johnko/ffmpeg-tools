#!/bin/sh

. /usr/local/bin/loadmyvars.sh

if [ "x" = "x$PERSONALMNT" ]; then
    PERSONALMNT=/vault/data
fi

 INPATH=$( pwd )
OUTPATH=${PERSONALMNT}/video/_done

install -d -m 755 -o urep ${INPATH}
install -d -m 755 -o urep ${OUTPATH}
chown -R urep ${INPATH}
chown -R urep ${OUTPATH}

ls -1 "${INPATH}" \
| while read line ; do
    if [ "x" != "x${line}" ]; then
        if [ ! -e "${OUTPATH}/${line}.mp4" ]; then
            echo "${line}"
            if [ -e "${OUTPATH}/${line}.mp4.tmp" ]; then
		rm "${OUTPATH}/${line}.mp4.tmp"
            fi
            echo "re-encode and compressor audio"
#/usr/local/bin/ffmpeg -hide_banner -i "${INPATH}/${line}" -map_metadata -1 -acodec aac -ac 2 -strict experimental -ab 160k -vcodec libx264 -preset slow -profile:v baseline -level 30 -maxrate 10000000 -bufsize 10000000 -b 1200k -f mp4 -threads 0 "${OUTPATH}/${line}.mp4.tmp"
            su -l urep -c sh <<EOF
/usr/local/bin/ffmpeg -hide_banner -i "${INPATH}/${line}" -map_metadata -1 -c:v libx264 -preset slow -profile:v baseline -level 3.0 -maxrate 10000000 -bufsize 10000000 -b:v 2000k -af "compand=0 0:1 1:-90/-900 -70/-70 -30/-9 0/-3:6:0:0:0" -strict -2 -c:a aac -b:a 256k -ac 2 -f mp4 -threads 0 "${OUTPATH}/${line}.mp4.tmp"
EOF
	    mv "${OUTPATH}/${line}.mp4.tmp" "${OUTPATH}/${line}.mp4"
        fi
    fi
done

### detect cropbars at 1 minute
# ffmpeg -ss 00:01:00 -i "${INPATH}/${line}" -t 1 -vf cropdetect -f null - 2>&1 | awk '/crop/ {print $NF}'
### do the cropping
# ffmpeg -hide_banner -i "${INPATH}/${line}" -vf $cropvalue -1 -c:v libx264 -preset slow -profile:v baseline -level 3.0 -maxrate 10000000 -bufsize 10000000 -b:v 2000k -c:a copy -f mp4 -threads 0 "${OUTPATH}/${line}.cropped.mp4"
